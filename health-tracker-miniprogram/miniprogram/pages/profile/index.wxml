<view class="container">
  <!-- KPI Section -->
  <view class="kpi-section">
    <view class="kpi-grid">
      <view class="card kpi-card">
        <text class="kpi-title">è¿ç»­è®°å½•å¤©æ•°</text>
        <text class="kpi-value">{{kpis.consecutiveDays}}å¤©</text>
        <text class="kpi-desc" wx:if="{{kpis.consecutiveDays > 0}}">{{kpis.consecutiveDays >= 7 ? 'åšæŒå¾—å¾ˆå¥½ï¼' : 'ç»§ç»­åŠ æ²¹ï¼'}}</text>
      </view>
      <view class="card kpi-card">
        <text class="kpi-title">å¹³å‡ç²¾åŠ›æ°´å¹³</text>
        <text class="kpi-value">{{kpis.averageEnergyLevel > 0 ? kpis.averageEnergyLevel + 'åˆ†' : 'æš‚æ— æ•°æ®'}}</text>
        <text class="kpi-desc" wx:if="{{kpis.averageEnergyLevel > 0}}">{{kpis.averageEnergyLevel >= 8 ? 'ç²¾åŠ›å……æ²›' : kpis.averageEnergyLevel >= 6 ? 'çŠ¶æ€è¾ƒå¥½' : 'éœ€è¦ä¼‘æ¯'}}</text>
      </view>
      <view class="card kpi-card">
        <text class="kpi-title">æœ¬æœˆè®°å½•æ¬¡æ•°</text>
        <text class="kpi-value">{{kpis.monthlyRecords}}æ¬¡</text>
        <text class="kpi-desc">{{kpis.monthlyRecords >= 10 ? 'è®°å½•å……åˆ†' : kpis.monthlyRecords >= 5 ? 'è®°å½•é€‚ä¸­' : 'å»ºè®®å¤šè®°å½•'}}</text>
      </view>
    </view>
  </view>

  <!-- Main Content -->
  <view class="main-content">
    <!-- Left Column: Calendar -->
    <view class="calendar-section">
      <view class="card">
        <!-- Calendar Header -->
        <view class="calendar-header">
          <view class="month-nav" bindtap="prevMonth">
            <text class="nav-arrow">â€¹</text>
          </view>
          <view class="month-title">{{currentYear}}å¹´{{currentMonth}}æœˆ</view>
          <view wx:if="{{showDebugButtons}}" class="refresh-btn" bindtap="getRecords">
            <text>ğŸ”„</text>
          </view>
          <view wx:if="{{showDebugButtons}}" class="debug-btn" bindtap="goToDebug">
            <text>ğŸ”</text>
          </view>
          <view class="month-nav" bindtap="nextMonth">
            <text class="nav-arrow">â€º</text>
          </view>
        </view>
        
        <!-- Week Headers -->
        <view class="week-header">
          <view class="week-day">æ—¥</view>
          <view class="week-day">ä¸€</view>
          <view class="week-day">äºŒ</view>
          <view class="week-day">ä¸‰</view>
          <view class="week-day">å››</view>
          <view class="week-day">äº”</view>
          <view class="week-day">å…­</view>
        </view>
        
        <!-- Calendar Grid -->
        <view class="calendar-grid">
          <block wx:for="{{calendarDays}}" wx:key="uniqueId">
            <view class="calendar-day {{item.hasRecord ? 'has-record' : ''}} {{item.isSelected ? 'selected' : ''}} {{item.isCurrentMonth ? '' : 'other-month'}}" 
                  bindtap="handleDateClick" 
                  data-date="{{item.date}}"
                  data-full-date="{{item.fullDate}}">
              <text class="day-number">{{item.day}}</text>
              <view wx:if="{{item.hasRecord}}" class="record-dot"></view>
            </view>
          </block>
        </view>
      </view>
    </view>
    
    <!-- Right Column: Record Details -->
    <view class="details-section">
      <view class="card">
        <!-- ä»Šæ—¥æ•°æ®æç¤º -->
        <view wx:if="{{!selectedRecord && records.length > 0}}" class="today-tip">
          <view class="tip-icon">ğŸ“…</view>
          <view class="tip-content">
            <text class="tip-title">ç‚¹å‡»æ—¥æœŸæŸ¥çœ‹è®°å½•</text>
            <text class="tip-subtitle">æœ‰æ•°æ®çš„æ—¥æœŸä¼šæ˜¾ç¤ºå°åœ†ç‚¹</text>
          </view>
        </view>
        
        <!-- æ— æ•°æ®æç¤º -->
        <view wx:if="{{records.length === 0}}" class="no-data-tip">
          <view class="tip-icon">ğŸ’¡</view>
          <view class="tip-content">
            <text class="tip-title">è¿˜æ²¡æœ‰å¥åº·è®°å½•</text>
            <text class="tip-subtitle">å®Œæˆå¥åº·è¯Šæ–­åæ•°æ®ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</text>
            <button class="start-assessment-btn" bindtap="goToAssessment">å¼€å§‹å¥åº·è¯Šæ–­</button>
          </view>
        </view>
        
        <view wx:if="{{selectedRecord}}" class="record-card">
          <view class="record-header">
            <text class="record-date">{{selectedRecord.date}}</text>
            <text class="record-time">{{selectedRecord.time}}</text>
          </view>
          
          <view class="record-content">
            <!-- å¥åº·è¯„åˆ† -->
            <view class="record-item" wx:if="{{selectedRecord.healthScore}}">
              <text class="item-label">å¥åº·è¯„åˆ†ï¼š</text>
              <text class="item-value health-score">{{selectedRecord.healthScore}}åˆ†</text>
            </view>
            
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <view class="record-item" wx:if="{{selectedRecord.age}}">
              <text class="item-label">å¹´é¾„æ€§åˆ«ï¼š</text>
              <text class="item-value">{{selectedRecord.age}}å² / {{selectedRecord.gender}}</text>
            </view>
            
            <!-- BMIä¿¡æ¯ -->
            <view class="record-item" wx:if="{{selectedRecord.bmi}}">
              <text class="item-label">BMIï¼š</text>
              <text class="item-value">{{selectedRecord.bmi}} ({{selectedRecord.bmiStatus}})</text>
            </view>
            
            <view class="record-item" wx:if="{{selectedRecord.weight && selectedRecord.height}}">
              <text class="item-label">èº«é«˜ä½“é‡ï¼š</text>
              <text class="item-value">{{selectedRecord.height}}cm / {{selectedRecord.weight}}kg</text>
            </view>
            
            <!-- ä¸­åŒ»ä½“è´¨ -->
            <view class="record-item" wx:if="{{selectedRecord.constitution}}">
              <text class="item-label">ä¸­åŒ»ä½“è´¨ï¼š</text>
              <text class="item-value constitution">{{selectedRecord.constitution}}</text>
            </view>
            
            <!-- é£é™©å› ç´  -->
            <view class="record-notes" wx:if="{{selectedRecord.notes}}">
              <text class="notes-label">å¥åº·æç¤ºï¼š</text>
              <text class="notes-content">{{selectedRecord.notes}}</text>
            </view>
            
            <!-- æ•´ä½“è¯„ä¼° -->
            <view class="record-assessment" wx:if="{{selectedRecord.overallAssessment}}">
              <text class="assessment-label">å¥åº·è¯„ä¼°ï¼š</text>
              <text class="assessment-content">{{selectedRecord.overallAssessment}}</text>
            </view>
          </view>
          
          <!-- æ“ä½œæŒ‰é’® -->
          <view class="record-actions">
            <button class="action-btn secondary" bindtap="viewFullAnalysis" data-record-id="{{selectedRecord._id}}">æŸ¥çœ‹å®Œæ•´åˆ†æ</button>
            <button wx:if="{{showDebugButtons}}" class="action-btn debug" bindtap="debugRecord" data-record="{{selectedRecord}}">è°ƒè¯•ä¿¡æ¯</button>
          </view>
        </view>
        
        <view wx:else class="no-record">
          <text class="no-record-text">è¯·é€‰æ‹©æ—¥æœŸæŸ¥çœ‹å¥åº·è®°å½•</text>
        </view>
      </view>
    </view>
  </view>
</view>