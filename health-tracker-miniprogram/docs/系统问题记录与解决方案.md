# 🚨 系统问题记录与解决方案

> **更新时间：** 2025-08-05  
> **目的：** 为新的Claude Code会话提供完整的问题背景和解决方案

## 📋 项目概述
**项目名称：** 智慧健康诊断小程序  
**主要功能：** 中医舌诊健康评估、AI问答分析、健康档案管理  
**技术栈：** 微信小程序 + 微信云开发 + 阿里云通义千问API + Google Gemini API

---

## 🔥 重大问题：数据保存失败

### 问题描述
- **症状：** 用户完成健康诊断后，数据无法保存到数据库
- **表现：** 健康档案页面始终显示只有1条老记录（8月1日），新的诊断记录不显示
- **用户反馈：** "为什么会不断地出错？之前没有的会突然出现"

### 🔍 问题排查过程

#### 第1阶段：怀疑AI分析问题
**错误判断：** 看到AI分析失败，以为是API调用问题
- 尝试修复Qwen API网络连接
- 实现图片上传重试机制
- 添加双API竞速功能
- **结果：** 问题依然存在

#### 第2阶段：怀疑代码逻辑问题
**错误判断：** 认为是analyze云函数的保存逻辑有问题
- 修改云函数，从"更新记录"改为"创建新记录"
- 添加详细的调试日志
- 完善错误处理机制
- **结果：** 问题依然存在

#### 第3阶段：发现真相
**关键发现：** 错误信息 `E11000 duplicate key error collection: health_records index: userId dup key`

**根本原因：** 
```
数据库health_records集合设置了userId字段的唯一索引（unique index）
这导致每个用户只能有1条记录，新记录插入时被数据库拒绝
```

### ✅ 解决方案
**操作步骤：**
1. 打开微信开发者工具 → 云开发 → 数据库
2. 选择 health_records 集合
3. 进入索引管理
4. 删除 userId 字段的唯一索引

**结果：** 
- ✅ 数据保存功能立即恢复正常
- ✅ 可以创建多条健康记录
- ✅ 历史数据正常显示

---

## 🔧 其他已解决的问题

### 1. 日历显示错误
**问题：** 8月2日显示在星期日下面，应该在星期六
**原因：** CSS flexbox布局可能导致渲染不一致
**解决：** 改用CSS Grid layout确保严格7列布局

### 2. 图片上传网络错误
**问题：** `Client network socket disconnected before secure TLS connection was established`
**原因：** 网络环境TLS连接不稳定
**解决：** 实现智能重试机制，支持3次重试，失败后可跳过继续诊断

### 3. wx:key重复警告
**问题：** 日历组件出现重复key警告
**解决：** 为每个日历项添加唯一ID（prev-、curr-、next-前缀）

---

## 🏗️ 当前系统架构

### AI分析流程
```
1. 优先使用 Qwen API (阿里云通义千问)
2. 备选使用 Gemini API (Google)
3. 失败时使用备用分析方案
4. 无论AI成功与否，都会保存数据到数据库
```

### 数据库设计
- **集合名：** health_records
- **重要：** 已删除userId唯一索引，支持多条记录
- **字段：** userId, createTime, formData, analysis, date, fullDate等

### 云函数
- **analyze：** 主要分析函数，包含AI调用和数据保存
- **getRecords：** 获取用户健康记录
- **generate-questions：** 生成AI澄清问题

---

## 🔑 API配置

### Qwen API
- **提供商：** 阿里云DashScope
- **模型：** qwen-vl-max (支持多模态图像分析)
- **Key：** sk-252e1b8e87bd41d3abf36dd12780cacf
- **状态：** ✅ 配置完成，网络可能不稳定

### Google Gemini API
- **状态：** ⚠️ 网络环境限制，暂时不可用
- **备注：** 需要稳定的国际网络环境

---

## 📝 完整的Prompt设计

系统使用详细的中医专家prompt：
```
你是一位拥有40年临床经验的资深老中医，同时精通现代西医学。
你曾师从多位国医大师，在北京中医药大学任教多年...
[完整prompt已保存在analyze云函数中]
```

**特点：**
- 📋 包含用户基本信息、BMI计算
- 🔍 支持舌诊问答结果分析
- 🤖 支持AI澄清问题深度分析
- 📊 返回结构化JSON结果
- 🏥 符合中医诊断规范

---

## ⚡ 当前状态总结

### ✅ 已正常工作的功能
- 数据库保存和读取
- 日历显示和交互
- 健康记录查看
- 调试功能完善
- 备用分析方案

### ⚠️ 需要关注的问题
- Qwen API网络连接不稳定
- 图片上传偶尔失败
- AI分析可能降级到备用方案

### 🔧 可优化的方向
- 改善网络连接稳定性
- 优化AI分析准确性
- 添加更多健康指标

---

## 🎯 给新Claude Code会话的建议

1. **优先检查数据库状态** - 确认唯一索引已删除
2. **测试数据保存功能** - 使用调试页面的"测试保存"功能
3. **关注网络问题** - TLS连接和API调用可能不稳定
4. **理解错误优先级** - 数据保存问题 > AI分析问题 > UI显示问题

**记住：数据保存功能的正常运行比AI分析更重要！**